<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="batch">

<select id="getCycleList" resultType="cycleVo">
	SELECT *
	FROM	CYCLE
</select>


<insert id="mergeDaily" parameterType="dailyVo">
	MERGE INTO DAILY
		USING DUAL ON (
			DAILY.PID = #{pid} AND
			DAILY.CID = #{cid} AND
			DAILY.DT = #{dt}
		)
		WHEN MATCHED THEN UPDATE SET
			CNT = #{cnt}
		WHEN NOT MATCHED THEN INSERT
			(PID, CID, DT, CNT)
			VALUES (#{pid}, #{cid}, #{dt}, #{cnt})
</insert>


<delete id="deleteDaily" parameterType="string">
	DELETE DAILY
	WHERE DT LIKE #{ym} || '%'
</delete>


<insert id="createDaily" parameterType="string">
	INSERT INTO DAILY
	SELECT CYCLE.CID, CYCLE.PID, CAL.DT, CYCLE.CNT
	FROM CYCLE,
	(SELECT TO_CHAR(TO_DATE(#{ym}, 'YYYYMM') + (LEVEL-1), 'YYYYMMDD') DT,
	       TO_CHAR(TO_DATE(#{ym}, 'YYYYMM') + (LEVEL-1), 'D') DAY
	FROM DUAL
	CONNECT BY LEVEL  &lt;= LAST_DAY(TO_DATE(#{ym}, 'YYYYMM')) - TO_DATE(#{ym}, 'YYYYMM')+1) CAL
	WHERE CYCLE.DAY = CAL.DAY
	ORDER BY CYCLE.CID, CYCLE.PID, CAL.DT
</insert>


<insert id="insertBatch" parameterType="batchVo">
	<selectKey keyProperty="bid" keyColumn="bid" resultType="int" order="BEFORE">
		SELECT SEQ_BATCH.NEXTVAL BID FROM DUAL
	</selectKey>
	INSERT INTO BATCH VALUES (#{bid}, #{bcd}, #{st}, SYSDATE, NULL)
</insert>


<update id="updateBatch" parameterType="batchVo">
	UPDATE 		BATCH 
	SET 				ST = #{st}, 
						ED_DT = SYSDATE
	WHERE		BID = #{bid}
</update>
</mapper>